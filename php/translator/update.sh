#! /bin/sh

# $1 = target directory
# $2 = branch to merge from

[ -z "$1" ] && return 1
[ -d "$1" ] || return 2

if [ -z "$TERM" -o "$TERM" = "dumb" ] ; then
	export TERM=xterm
fi

eval $(keychain -q --eval)

cd $1

rm commit.log

ret=0
if [ $(git diff --shortstat | wc -l) != 0 ] ; then
	git commit -am "auto commit for translation" --author "ub0r bot <noreply@ub0r.de>" > commit.log 2> commit.log
	rc=$?
	if [ $rc != 0 ] ; then
		ret=$rc
		echo rc=$ret | tee -a commit.log
	fi
fi
git pull >> commit.log 2>> commit.log
rc=$?
if [ $rc != 0 ] ; then
	ret=$rc
	echo rc=$ret | tee -a commit.log
fi
[ -n "$2" ] && git merge $2 >> commit.log 2>> commit.log
rc=$?
if [ $rc != 0 ] ; then
	ret=$rc
	echo rc=$ret | tee -a commit.log
fi
git push origin $(git branch --no-color | grep '*' | cut -d\  -f2) >> commit.log 2>> commit.log
rc=$?
if [ $rc != 0 ] ; then
	ret=$rc
	echo rc=$ret | tee -a commit.log
fi

if [ $ret != 0 ] ; then
	cat commit.log
fi
